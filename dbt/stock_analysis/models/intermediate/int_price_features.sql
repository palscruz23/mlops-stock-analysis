 SELECT
      *,
      LAG(CLOSE, 1, 0) over (PARTITION BY TICKER ORDER BY DATETIME) AS PREV_PRICE,
      (CLOSE - PREV_PRICE) / PREV_PRICE AS PERC_CHANGE,
      AVG(CLOSE) OVER (PARTITION BY TICKER ORDER BY DATETIME ROWS BETWEEN 4 PRECEDING AND CURRENT ROW) AS SMA_5,
      AVG(CLOSE) OVER (PARTITION BY TICKER ORDER BY DATETIME ROWS BETWEEN 20 PRECEDING AND CURRENT ROW) AS SMA_20,
      AVG(VOLUME) OVER (PARTITION BY TICKER ORDER BY DATETIME ROWS BETWEEN 20 PRECEDING AND CURRENT ROW) AS VOL_20,
      (HIGH - LOW) / CLOSE AS VOLATILITY
  FROM {{ ref('stg_price') }}